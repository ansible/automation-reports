# Data Model: AAP Instance Setup (Phase 1)

**Date**: 2026-01-26  
**Spec**: [spec-phase1-aap-setup.md](spec-phase1-aap-setup.md)  
**Plan**: [plan-phase1-aap-setup.md](plan-phase1-aap-setup.md)

## Overview

Phase 1 focuses on AAP instance setup. The primary data artifact is the `aap_access.json` file which stores connection information for later phases.

## Entity: aap_access.json

**Purpose**: Store AAP connection details for use by Phase 2+ scripts

**Location**: `tests/integration/aap_access.json` (generated by setup script)

**Format**: JSON

### Fields

| Field | Type | Phase 1 Value | Description | Validation |
|-------|------|---------------|-------------|------------|
| `client_id` | string \| null | `null` | OAuth2 client ID (Phase 2) | Not applicable in Phase 1 |
| `client_secret` | string \| null | `null` | OAuth2 client secret (Phase 2) | Not applicable in Phase 1 |
| `access_token` | string \| null | `null` | OAuth2 access token (Phase 2) | Not applicable in Phase 1 |
| `refresh_token` | string \| null | `null` | OAuth2 refresh token (Phase 2) | Not applicable in Phase 1 |
| `aap_url` | string | `"http://localhost:44926"` | Full AAP base URL | Must be valid URL format |
| `aap_protocol` | string | `"http"` or `"https"` | Protocol scheme | Must be "http" or "https" |
| `aap_address` | string | `"localhost"` | Hostname or IP address | Must not contain protocol or port |
| `aap_port` | string | `"44926"` or `"44925"` | Port number | Must match AAP version (25→44925, 26→44926) |
| `aap_version` | string | `"2.5"` or `"2.6"` | AAP version | Must be "2.5" or "2.6" |
| `aap_password` | string | `"<password>"` | Admin password | Must not be empty |

### Example (Phase 1)

```json
{
    "client_id": null,
    "client_secret": null,
    "access_token": null,
    "refresh_token": null,
    "aap_url": "http://localhost:44926",
    "aap_protocol": "http",
    "aap_address": "localhost",
    "aap_port": "44926",
    "aap_version": "2.6",
    "aap_password": "admin123password"
}
```

### Field Dependencies

- `aap_url` = `${aap_protocol}://${aap_address}:${aap_port}`
- `aap_port` correlates with `aap_version`:
  - AAP 2.5 → port 44925
  - AAP 2.6 → port 44926
- `aap_password` retrieved from `~/.aap-dev/admin_password.txt`

### Validation Rules

1. **URL Consistency**: `aap_url` must match reconstructed URL from components
2. **Port-Version Match**: Port must match AAP version convention
3. **Non-empty Password**: `aap_password` must not be empty string
4. **Null OAuth Fields**: All OAuth2 fields must be null in Phase 1
5. **Version Format**: `aap_version` must be "2.5" or "2.6" (not "25" or "26")

### State Transitions

**Phase 1 → Phase 2**:
- OAuth2 fields change from `null` to actual values
- Other fields remain unchanged
- `aap_password` may become optional once OAuth2 is configured

---

## Entity: Environment Variables

**Purpose**: Export AAP connection info for shell-based later phases

**Scope**: Process environment of setup script and child processes

### Variables

| Variable | Type | Example | Description |
|----------|------|---------|-------------|
| `AAP_URL` | string | `http://localhost:44926` | Full AAP base URL |
| `AAP_PASSWORD` | string | `admin123password` | Admin password |
| `AAP_VERSION` | string | `26` | Internal version code (25 or 26) |
| `AAP_USERNAME` | string | `admin` | Admin username (constant) |

### Usage

```bash
# Exported by setup_aap.sh
export AAP_URL="http://localhost:44926"
export AAP_PASSWORD="$(cat ~/.aap-dev/admin_password.txt)"
export AAP_VERSION="26"
export AAP_USERNAME="admin"

# Used by Phase 2+
./setup_aap_data.sh  # Will read from environment
```

---

## Entity: aap-dev Configuration

**Purpose**: Track aap-dev repository state and version

**Location**: `tests/integration/aap-dev/` (git clone)

### Attributes

| Attribute | Type | Description | Source |
|-----------|------|-------------|--------|
| Repository URL | URL | `https://github.com/ansible/aap-dev` | Hardcoded |
| Checked out ref | git ref | Commit SHA, branch, or tag | `--aap-dev-version` parameter |
| AAP Version | string | "25" or "26" | `--aap-version` parameter |
| Admin password location | path | `~/.aap-dev/admin_password.txt` | aap-dev convention |
| Config location | path | `~/.aap-dev/config.yml` | aap-dev convention |

### Lifecycle

1. **Clone**: `git clone https://github.com/ansible/aap-dev`
2. **Checkout**: `git checkout ${AAP_DEV_VERSION}` (if specified)
3. **Configure**: Set `AAP_VERSION` environment variable
4. **Start**: Execute `make install && make start`
// This 'make install' is implemented in aap-dev Makefile - yes or no?
5. **Cleanup**: Execute `make stop` + remove directory

---

## Entity: AAP Instance

**Purpose**: Running AAP containers managed by aap-dev

**State**: Ephemeral (destroyed on cleanup)

### Attributes

| Attribute | Type | Value | Description |
|-----------|------|-------|-------------|
| Version | string | "2.5" or "2.6" | AAP version |
| Port | integer | 44925 or 44926 | HTTP API port |
| Admin username | string | "admin" | Fixed username |
| Admin password | string | Generated | Retrieved from aap-dev |
| Health endpoint | URL | `/api/gateway/v1/ping/` or `/api/v2/ping/` | Version-dependent |
| Container runtime | string | "docker" or "podman" | Auto-detected |

### Health States

1. **Not Started**: Containers don't exist
2. **Starting**: Containers exist but API not responding
3. **Ready**: API responds 200 OK to health check
4. **Failed**: Startup timeout or error

### Health Check Logic

```
Poll every 5 seconds for 600 seconds maximum:
  1. Try /api/gateway/v1/ping/ (AAP 2.5+)
  2. If fails, try /api/v2/ping/ (AAP 2.4)
// version is known - input param. Use known version.
  3. If both fail, continue polling
  4. If timeout reached, fail with diagnostics
```

---

## Data Flow

```
Setup Script Start
    ↓
Check Prerequisites
(docker, git, curl, disk space)
    ↓
Clone/Update aap-dev
(--aap-dev-version)
    ↓
Start AAP Instance
(make install && make start)
    ↓
Wait for Ready State
(health check polling)
    ↓
Retrieve Credentials
(~/.aap-dev/admin_password.txt)
    ↓
Generate aap_access.json
(parse URL, populate fields)
    ↓
Export Environment Variables
(AAP_URL, AAP_PASSWORD)
    ↓
Success
```

---

## Relationships

```
aap-dev Repository
    ├── controls → AAP Instance (via make targets)
    ├── generates → Admin Credentials (~/.aap-dev/)
    └── provides → Health Check Endpoints
    
setup_aap.sh Script
    ├── clones → aap-dev Repository
    ├── monitors → AAP Instance (health checks)
    ├── reads → Admin Credentials
    ├── generates → aap_access.json
    └── exports → Environment Variables
    
aap_access.json
    └── consumed by → Phase 2+ scripts
    
Environment Variables
    └── consumed by → Phase 2+ scripts
```

---

## Validation Checklist

Phase 1 data is valid when:

- [ ] aap_access.json exists at tests/integration/aap_access.json
- [ ] All required fields are present in JSON
- [ ] OAuth2 fields are null
- [ ] aap_url matches parsed components
- [ ] aap_port matches aap_version
- [ ] aap_password is non-empty
- [ ] Environment variables AAP_URL and AAP_PASSWORD are exported
- [ ] AAP instance responds 200 OK to health check
- [ ] Admin credentials can authenticate to AAP API

---

## Future Phases

**Phase 2** will populate OAuth2 fields in aap_access.json:
- Create OAuth2 application in AAP
- Generate access/refresh tokens
- Update JSON file with real values

**Phase 3+** will consume aap_access.json:
- Read connection details for container configuration
- Use credentials for setclusters command
- Use OAuth2 tokens for syncdata operations
