---
- name: Preflight checks
  hosts: localhost
  gather_facts: false
  connection: local
  become: false
  tasks:
    - name: Gather facts
      ansible.builtin.setup:

    - name: Get ostree fact
      ansible.builtin.import_role:
        name: common
        tasks_from: ostree.yml

    - name: Run preflight checks
      ansible.builtin.import_role:
        name: preflight

- name: Install common container components
  hosts: automationcontroller:automationeda:automationhub:database:execution_nodes:automationdashboard:redis
  any_errors_fatal: true
  gather_facts: false
  become: false
  tasks:
    - name: Gather facts
      ansible.builtin.setup:
      become: true

    - name: Gather regular user id, uid and home dir
      ansible.builtin.setup:
        filter:
          - 'ansible_user_id'
          - 'ansible_user_uid'
          - 'ansible_user_dir'

    - name: Install and configure podman
      ansible.builtin.import_role:
        name: common

- name: Install the database - containerized
  hosts: database
  any_errors_fatal: true
  gather_facts: false
  become: false
  tasks:
    - name: Install and configure postgresql
      ansible.builtin.import_role:
        name: postgresql
      when: dashboard_pg_containerized

- name: Install the database - non-containerized
  hosts: database
  any_errors_fatal: true
  gather_facts: false
  become: false
  tasks:
    - name: Install and configure postgresql
      ansible.builtin.import_role:
        name: postgresql
        tasks_from: conf.yml
      when: not dashboard_pg_containerized

- name: Install redis cluster cache
  hosts: redis
  any_errors_fatal: true
  gather_facts: false
  become: false
  tasks:
    - name: Install and configure redis cluster tcp socket
      ansible.builtin.include_role:
        name: redis
      vars:
        redis_unix_socket: false
        redis_cluster: true
      when: redis_mode | default('cluster') == 'cluster'

- name: Install the redis cache
  hosts: automationcontroller:automationeda:automationgateway:automationhub:automationdashboard
  any_errors_fatal: true
  gather_facts: false
  become: false
  tasks:
    - name: Install and configure redis unix socket
      ansible.builtin.include_role:
        name: redis
      when: >
        inventory_hostname in groups.get('automationcontroller', []) or
        inventory_hostname in groups.get('automationhub', []) or
        (inventory_hostname in groups.get('automationeda', []) and groups.get('automationeda', []) | length == 1) or
        (inventory_hostname in groups.get('automationdashboard', []) and groups.get('automationdashboard', []) | length == 1)

    # group automationgateway in not defined when installing only automationdashboard
    # - name: Install and configure redis tcp socket
    #   ansible.builtin.include_role:
    #     name: redis
    #   vars:
    #     redis_unix_socket: false
    #   when:
    #     - redis_mode | default('cluster') == 'standalone'
    #     - inventory_hostname == groups['automationgateway'] | first

- name: Install the Automation Dashboard
  any_errors_fatal: true
  hosts: automationdashboard
  gather_facts: false
  become: false
  tasks:
    - name: Install and configuration automation dashboard
      ansible.builtin.import_role:
        name: automationdashboard
...
