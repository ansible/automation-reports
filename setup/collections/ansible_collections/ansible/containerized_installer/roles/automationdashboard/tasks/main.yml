---
- name: Set automation dashboard facts
  ansible.builtin.include_tasks: facts.yml

- name: Create the dashboard directories
  ansible.builtin.file:
    path: '{{ item }}'
    mode: '0770'
    state: directory
  loop:
    - '{{ dashboard_conf_dir }}/conf.d'
    # - '{{ dashboard_data_dir }}/job_execution'
    # - '{{ dashboard_data_dir }}/projects'
    # - '{{ dashboard_data_dir }}/rsyslog'

- name: Configure postgresql
  ansible.builtin.include_tasks: postgresql.yml
  args:
    apply:
      run_once: true

- name: Configure TLS
  ansible.builtin.include_tasks: tls.yml
  when: not nginx_disable_https | bool

- name: Configure nginx
  ansible.builtin.include_tasks: nginx.yml

# - name: Configure rsyslog
#   ansible.builtin.include_tasks: rsyslog.yml

- name: Configure supervisor
  ansible.builtin.include_tasks: supervisor.yml

- name: Configure dispatcher
  ansible.builtin.include_tasks: dispatcher.yml

- name: Configure podman secrets
  ansible.builtin.include_tasks: secrets.yml

# - name: Create the dashboard configuration
#   ansible.builtin.template:
#     src: settings.py.j2
#     dest: '{{ dashboard_conf_dir }}/settings.py'
#     mode: '0640'
#   notify:
#     - Restart dashboard rsyslog
#     - Restart dashboard task
#     - Restart dashboard web

- name: Create the dashboard extra configurations
  ansible.builtin.template:
    src: '{{ item }}.py.j2'
    dest: '{{ dashboard_conf_dir }}/conf.d/{{ item }}.py'
    mode: '0640'
  loop:
    - django_dashboard_conf
    # - cluster_host_id
    # - container_groups
    # - execution_environments
    # - insights
    # - subscription_usage_model
  notify:
    # - Restart dashboard rsyslog
    - Restart dashboard task
    - Restart dashboard web

- name: Create the dashboard uwsgi configuration
  ansible.builtin.template:
    src: uwsgi.ini.j2
    dest: '{{ dashboard_conf_dir }}/uwsgi.ini'
    mode: '0640'
  notify: Restart dashboard web

- name: Create task/web custom command
  ansible.builtin.template:
    src: '{{ item }}.j2'
    dest: '{{ dashboard_conf_dir }}/{{ item }}'
    mode: '0755'
  loop:
    - launch_dashboard_task.sh
    - launch_dashboard_web.sh

- name: Configure containers
  ansible.builtin.include_tasks: containers.yml

- name: Configure systemd
  ansible.builtin.include_tasks: systemd.yml

- name: Add firewalld rules
  ansible.builtin.include_tasks: firewalld.yml
  vars:
    __firewalld_state: enabled
...
